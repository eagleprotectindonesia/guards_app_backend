generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum AdminRole {
  superadmin
  admin
}

enum EmployeeRole {
  on_site
  office
}

model Permission {
  id          String   @id @default(uuid())
  action      String // e.g., "view", "create", "edit", "delete"
  resource    String // e.g., "employees", "shifts", "admin_dashboard"
  code        String   @unique // e.g., "employees:view"
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  roles       Role[]   @relation("RolePermissions")

  @@map("permissions")
}

model Role {
  id          String       @id @default(uuid())
  name        String       @unique
  description String?
  permissions Permission[] @relation("RolePermissions")
  admins      Admin[]
  isSystem    Boolean      @default(false) @map("is_system")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  @@map("roles")
}

model Admin {
  id                 String      @id @default(uuid())
  name               String
  email              String      @unique
  profileImage       String?     @map("profile_image")
  hashedPassword     String      @map("hashed_password")
  twoFactorSecret    String?     @map("two_factor_secret")
  twoFactorEnabled   Boolean     @default(false) @map("two_factor_enabled")
  role               AdminRole   @default(admin) // Deprecated: use roleId
  roleId             String?     @map("role_id")
  roleRef            Role?       @relation(fields: [roleId], references: [id])
  tokenVersion       Int         @default(0) @map("token_version")
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  deletedAt          DateTime?   @map("deleted_at")
  note               String?     @db.Text
  acknowledgedAlerts Alert[]     @relation("AcknowledgedBy")
  resolvedAlerts     Alert[]     @relation("ResolvedBy")
  updatedSites       Site[]      @relation("SiteLastUpdatedBy")
  updatedOffices     Office[]    @relation("OfficeLastUpdatedBy")
  updatedShiftTypes  ShiftType[] @relation("ShiftTypeLastUpdatedBy")
  updatedShifts      Shift[]     @relation("ShiftLastUpdatedBy")
  createdSites       Site[]      @relation("SiteCreatedBy")
  createdOffices     Office[]    @relation("OfficeCreatedBy")
  createdShiftTypes  ShiftType[] @relation("ShiftTypeCreatedBy")
  createdShifts      Shift[]     @relation("ShiftCreatedBy")
  changelogs         Changelog[]
  sentMessages       ChatMessage[]

  @@index([deletedAt])
  @@map("admins")
}

enum ChangelogActor {
  admin
  system
  unknown
}

model Changelog {
  id         String         @id @default(uuid())
  action     String // CREATE, UPDATE, DELETE, BULK_CREATE
  entityType String         @map("entity_type") // e.g., "Employee", "Site"
  entityId   String         @map("entity_id")
  details    Json? // Store changed fields or snapshot
  actor      ChangelogActor @default(admin)
  actorId    String?        @map("actor_id")
  createdAt  DateTime       @default(now()) @map("created_at")

  admin Admin? @relation(fields: [actorId], references: [id])

  @@index([entityType, entityId])
  @@index([entityType, createdAt])
  @@index([createdAt])
  @@map("changelogs")
}

model ChatMessage {
  id          String         @id @default(uuid())
  employeeId  String         @map("employee_id")
  adminId     String?        @map("admin_id") // If sent by admin
  sender      ChatSenderType
  content     String         @db.Text
  attachments String[]
  createdAt   DateTime       @default(now()) @map("created_at")
  readAt      DateTime?      @map("read_at")

  employee Employee @relation(fields: [employeeId], references: [id])
  admin    Admin?   @relation(fields: [adminId], references: [id])

  @@index([employeeId, createdAt])
  @@map("chat_messages")
}

enum ChatSenderType {
  admin
  employee
}


model Employee {
  id              String       @id
  employeeNumber  String?      @map("employee_number")
  personnelId     String?      @map("personnel_id")
  nickname        String?
  fullName        String       @map("full_name")
  jobTitle        String?      @map("job_title")
  department      String?
  phone           String       @unique
  hashedPassword  String       @map("password")
  tokenVersion    Int          @default(0) @map("token_version")
  role            EmployeeRole?
  status          Boolean?     @default(true)
  note            String?      @db.Text
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?    @map("deleted_at")
  checkins        Checkin[]
  shifts          Shift[]
  attendances     Attendance[]
  officeAttendances OfficeAttendance[]
  chatMessages    ChatMessage[]
  refreshTokens   RefreshToken[]

  @@index([status])
  @@index([deletedAt])
  @@index([employeeNumber])
  @@map("employees")
}

model Site {
  id              String    @id @default(uuid())
  name            String    @unique
  clientName      String?   @map("client_name")
  address         String?
  latitude        Float?
  longitude       Float?
  geofenceRadius  Float     @default(100.0) @map("geofence_radius")
  geofenceStatus  Boolean?  @default(true) @map("geofence_status")
  status          Boolean?  @default(true)
  lastUpdatedById String?   @map("last_updated_by_id")
  createdById     String?   @map("created_by_id")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime? @map("deleted_at")
  note            String?   @db.Text
  alerts          Alert[]
  shifts          Shift[]
  lastUpdatedBy   Admin?    @relation("SiteLastUpdatedBy", fields: [lastUpdatedById], references: [id])
  createdBy       Admin?    @relation("SiteCreatedBy", fields: [createdById], references: [id])

  @@index([status])
  @@index([deletedAt])
  @@map("sites")
}

model Office {
  id              String    @id @default(uuid())
  name            String
  address         String?
  latitude        Float?
  longitude       Float?
  status          Boolean?  @default(true)
  lastUpdatedById String?   @map("last_updated_by_id")
  createdById     String?   @map("created_by_id")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime? @map("deleted_at")
  note            String?   @db.Text
  officeAttendances OfficeAttendance[]
  lastUpdatedBy   Admin?    @relation("OfficeLastUpdatedBy", fields: [lastUpdatedById], references: [id])
  createdBy       Admin?    @relation("OfficeCreatedBy", fields: [createdById], references: [id])

  @@index([status])
  @@index([deletedAt])
  @@map("offices")
}

model ShiftType {
  id              String    @id @default(uuid())
  name            String    @unique
  startTime       String    @map("start_time")
  endTime         String    @map("end_time")
  lastUpdatedById String?   @map("last_updated_by_id")
  createdById     String?   @map("created_by_id")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime? @map("deleted_at")
  shifts          Shift[]
  lastUpdatedBy   Admin?    @relation("ShiftTypeLastUpdatedBy", fields: [lastUpdatedById], references: [id])
  createdBy       Admin?    @relation("ShiftTypeCreatedBy", fields: [createdById], references: [id])

  @@index([deletedAt])
  @@map("shift_types")
}

model Shift {
  id                          String         @id @default(uuid())
  siteId                      String         @map("site_id")
  shiftTypeId                 String         @map("shift_type_id")
  employeeId                  String?        @map("employee_id")
  date                        DateTime       @db.Date
  startsAt                    DateTime       @map("starts_at")
  endsAt                      DateTime       @map("ends_at")
  status                      ShiftStatus    @default(scheduled)
  checkInStatus               CheckInStatus? @map("check_in_status")
  requiredCheckinIntervalMins Int            @default(20) @map("required_checkin_interval_minutes")
  graceMinutes                Int            @default(2) @map("grace_minutes")
  lastHeartbeatAt             DateTime?      @map("last_heartbeat_at") @db.Timestamptz(6)
  lastDeviceHeartbeatAt       DateTime?      @map("last_device_heartbeat_at") @db.Timestamptz(6)

  missedCount                 Int            @default(0) @map("missed_count")
  createdById                 String?        @map("created_by_id")
  lastUpdatedById             String?        @map("last_updated_by_id")
  createdAt                   DateTime       @default(now()) @map("created_at")
  updatedAt                   DateTime       @updatedAt
  deletedAt                   DateTime?      @map("deleted_at")
  note                        String?        @db.Text
  alerts                      Alert[]
  checkins                    Checkin[]
  employee                    Employee?      @relation(fields: [employeeId], references: [id])
  shiftType                   ShiftType      @relation(fields: [shiftTypeId], references: [id])
  site                        Site           @relation(fields: [siteId], references: [id])
  createdBy                   Admin?         @relation("ShiftCreatedBy", fields: [createdById], references: [id])
  lastUpdatedBy               Admin?         @relation("ShiftLastUpdatedBy", fields: [lastUpdatedById], references: [id])
  attendance                  Attendance?

  @@index([siteId])
  @@index([employeeId, startsAt])
  @@index([startsAt, endsAt])
  @@index([employeeId, status, startsAt])
  @@index([employeeId, status, endsAt])
  @@index([status, endsAt, deletedAt])
  @@index([deletedAt])
  @@map("shifts")
}

model Checkin {
  id         String        @id @default(uuid())
  shiftId    String        @map("shift_id")
  employeeId String        @map("employee_id")
  at         DateTime      @default(now()) @db.Timestamptz(6)
  source     String?
  status     CheckInStatus
  metadata   Json?
  createdAt  DateTime      @default(now()) @map("created_at")
  employee   Employee      @relation(fields: [employeeId], references: [id])
  shift      Shift         @relation(fields: [shiftId], references: [id])

  @@unique([shiftId, at])
  @@index([createdAt])
  @@map("checkins")
}

model Alert {
  id               String           @id @default(uuid())
  shiftId          String           @map("shift_id")
  siteId           String           @map("site_id")
  reason           AlertReason
  severity         AlertSeverity
  windowStart      DateTime         @map("window_start") @db.Timestamptz(6)
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  acknowledgedAt   DateTime?        @map("acknowledged_at") @db.Timestamptz(6)
  acknowledgedById String?          @map("acknowledged_by_id")
  resolvedAt       DateTime?        @map("resolved_at") @db.Timestamptz(6)
  resolvedById     String?          @map("resolved_by_id")
  resolutionNote   String?          @map("resolution_note")
  resolutionType   AlertResolution? @map("resolution_type")
  ackAdmin         Admin?           @relation("AcknowledgedBy", fields: [acknowledgedById], references: [id])
  resolverAdmin    Admin?           @relation("ResolvedBy", fields: [resolvedById], references: [id])
  shift            Shift            @relation(fields: [shiftId], references: [id])
  site             Site             @relation(fields: [siteId], references: [id])

  @@unique([shiftId, reason, windowStart])
  @@index([siteId, createdAt])
  @@index([reason])
  @@map("alerts")
}

enum ShiftStatus {
  scheduled
  in_progress
  completed
  missed
  cancelled
}

enum CheckInStatus {
  on_time
  late
  invalid
}

enum AlertReason {
  missed_checkin
  missed_attendance
  geofence_breach
  location_services_disabled
}

enum AlertSeverity {
  warning
  critical
}

enum AlertResolution {
  standard
  forgiven
  auto
}

model Attendance {
  id         String           @id @default(uuid())
  shiftId    String           @map("shift_id")
  employeeId String?          @map("employee_id")
  recordedAt DateTime         @default(now()) @map("recorded_at") @db.Timestamptz(6)
  picture    String?
  status     AttendanceStatus
  metadata   Json?
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt

  shift    Shift     @relation(fields: [shiftId], references: [id])
  employee Employee? @relation(fields: [employeeId], references: [id])

  @@unique([shiftId])
  @@index([recordedAt])
  @@index([employeeId])
  @@map("attendance")
}

model SystemSetting {
  name  String @id
  value String
  note  String?

  @@map("system_settings")
}

enum AttendanceStatus {
  present
  absent
  late
  pending_verification
  clocked_out
}

model OfficeAttendance {
  id         String           @id @default(uuid())
  officeId   String           @map("office_id")
  employeeId String           @map("employee_id")
  recordedAt DateTime         @default(now()) @map("recorded_at") @db.Timestamptz(6)
  picture    String?
  status     AttendanceStatus
  metadata   Json?
  createdAt  DateTime         @default(now()) @map("created_at")
  updatedAt  DateTime         @updatedAt

  office     Office    @relation(fields: [officeId], references: [id])
  employee   Employee  @relation(fields: [employeeId], references: [id])

  @@index([recordedAt])
  @@index([employeeId])
  @@index([officeId])
  @@map("office_attendance")
}

model ApiKey {
  id         String   @id @default(uuid())
  name       String
  key        String   @unique // Hashed key
  status     Boolean  @default(true)
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("api_keys")
}

model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique // Hashed token
  employeeId  String   @map("employee_id")
  deviceInfo  String?  @map("device_info")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  revokedAt   DateTime? @map("revoked_at")
  replacedByToken String? @map("replaced_by_token")

  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([token])
  @@map("refresh_tokens")
}
